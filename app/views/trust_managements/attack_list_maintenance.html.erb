<script type="text/javascript">

	init_jqgrid_owners();

	init_jqgrid_buildings();

	init_jqgrid_trusts();

	// 貸主一覧表を作成
	function init_jqgrid_owners(){
		
		// 列名の定義
		var grid_name = ["id", "コード", "貸主名", "住所"];

		// 列属性の定義
		var grid_model = [
		  {name:"id", index:"id", width:10, align:"right", classes:"no_class", hidden:true}
		 ,{name:"code", index:"code", width:100, align:"center", classes:"no_class"}
		 ,{name:"name", index:"name", width:300, align:"left", classes:"no_class"}
		 ,{name:"address", index:"address", width:300, align:"left", classes:"no_class"}
		];

		// その他の設定
		var jqgrid_opt = {
			 table_name:'owner_table'
			,fotter_name:'owner_pager'
			,div_name:'owner_div'
			,caption:'貸主一覧'
			,event_type:30
			,shrinkFit:true
			,multiselect:false
		};

		$(function(){
			jqgrid_create(grid_name, grid_model, gon.owners, jqgrid_opt);	
		});
	}
	
	
	// 物件一覧表を作成
	function init_jqgrid_buildings(){
		
		// 列名の定義
		var grid_name = ["id", "コード", "建物名", "住所", "営業所"];

		// 列属性の定義
		var grid_model = [
		  {name:"id", index:"id", width:10, align:"right", classes:"no_class", hidden:true}
		 ,{name:"code", index:"code", width:100, align:"center", classes:"no_class"}
		 ,{name:"name", index:"name", width:300, align:"left", classes:"no_class"}
		 ,{name:"address", index:"address", width:300, align:"left", classes:"no_class"}
		 ,{name:"shop_name", index:"shop_name", width:200, align:"left", classes:"no_class"}
		];

		// その他の設定
		var jqgrid_opt = {
			 table_name:'building_table'
			,fotter_name:'building_pager'
			,div_name:'building_div'
			,caption:'物件一覧'
			,event_type:30
			,shrinkFit:true
			,multiselect:false
		};

		$(function(){
			jqgrid_create(grid_name, grid_model, gon.buildings, jqgrid_opt);	
		});
	}
	
	
	// 委託契約リストを作成
	function init_jqgrid_trusts(){
		// 列名の定義
		//var grid_name = ["trust_id", "owner_id", "見込貸主CD", "貸主名", "住所", "貸主備考", "building_id", "見込建物CD", "建物名", "住所", "建物備考", "営業所", "担当者"];
		var grid_name = ["trust_id", "owner_id", "見込貸主CD", "貸主名", "住所", "貸主備考", "building_id", "見込建物CD", "建物名", "住所", "建物備考", "現 管理会社", "営業所", "担当者"];
		
		// 列属性の定義
		var grid_model = [
		  {name:"trust_id", index:"trust_id", align:"right", classes:"no_class", hidden:true}
		 ,{name:"owner_id", index:"owner_id", align:"right", classes:"no_class", hidden:true}
		 ,{name:"owner_code", index:"owner_code", width:200, align:"center", classes:"no_class"}
		 ,{name:"owner_name", index:"owner_name", width:400, align:"left", classes:"no_class"}
		 ,{name:"owner_address", index:"owner_address", width:300, align:"left", classes:"no_class"}
		 ,{name:"owner_memo", index:"owner_memo", width:400, align:"left", classes:"no_class"}
		 ,{name:"building_id", index:"building_id", align:"right", classes:"no_class", hidden:true}
		 ,{name:"building_code", index:"building_code", width:200, align:"center", classes:"no_class"}
		 ,{name:"building_name", index:"building_name", width:400, align:"left", classes:"no_class"}
		 ,{name:"building_address", index:"building_address", width:300, align:"left", classes:"no_class"}
		 ,{name:"building_memo", index:"building_memo", width:400, align:"left", classes:"no_class"}
		 ,{name:"proprietary_company", index:"proprietary_company", width:200, align:"left", classes:"no_class"}
		 ,{name:"shop_name", index:"shop_memo", align:"left", classes:"no_class"}
		 ,{name:"user_name", index:"user_memo", align:"left", classes:"no_class"}
		];
		
		// データの作成
		var grid_data = [];
		cnt = 1;
		gon.trusts.forEach(function(trust_manage){
			var rec = {};
			
			rec['trust_id'] = trust_manage.trust_id
			rec['owner_id'] = trust_manage.owner_id
			rec['owner_code'] = trust_manage.owner_attack_code
					
			if(trust_manage.owner_dm_delivery == 't'){
				rec['owner_dm_delivery'] = '○'
			}else{
				rec['owner_dm_delivery'] = '×'
			}
			
			rec['owner_name'] = trust_manage.owner_name
			rec['owner_address'] = trust_manage.owner_address
			rec['owner_memo'] = trust_manage.owner_memo
			rec['building_id'] = trust_manage.building_id
			rec['building_code'] = trust_manage.building_attack_code
			rec['building_name'] = trust_manage.building_name
			rec['building_address'] = trust_manage.building_address
			rec['building_memo'] = trust_manage.building_memo
			rec['proprietary_company'] = trust_manage.building_proprietary_company
			
			rec['shop_name'] = trust_manage.shop_name
			rec['user_name'] = trust_manage.biru_user_name
		
			grid_data.push(rec);
			
		});
		
		// その他の設定
		var jqgrid_opt = {
			 table_name:'trust_table'
			,fotter_name:'trust_pager'
			,div_name:'trust_div'
			,caption:'アタックリスト'
			,event_type:30
			,shrinkFit:true
			,multiselect:true
		};
			
		
		$(function(){
			jqgrid_create(grid_name, grid_model, grid_data, jqgrid_opt);
		});
	}
	
	
	
	// 登録チェック
	function create_trust(){
		
		//--------------------------
		// 貸主の現在の選択行を取得
		//--------------------------
		var owner_row = $("#owner_table").jqGrid('getGridParam', 'selrow');
		var owner_row_data = $('#owner_table').getRowData()

		// 行IDを取得
		var owner_ids = $("#owner_table").jqGrid('getDataIDs');
		for(var owner_i=0; owner_i< owner_ids.length; owner_i++){
			if(owner_row == owner_ids[owner_i]){
				break; //発見
			}
		}

		if( owner_i < owner_ids.length ){
			document.create_trust_form.owner_id.value = owner_row_data[owner_i].id
			
		} else {
			alert("紐付ける貸主を選択してください。");
			return false;
		}



		//--------------------------
		// 物件の現在の選択行を取得
		//--------------------------
		var building_row = $("#building_table").jqGrid('getGridParam', 'selrow');
		var building_row_data = $('#building_table').getRowData()

		// 行IDを取得
		var building_ids = $("#building_table").jqGrid('getDataIDs');
		for(var building_i=0; building_i< building_ids.length; building_i++){
			if(building_row == building_ids[building_i]){
				break;
			}
		}

		if( building_i < building_ids.length ){
			document.create_trust_form.building_id.value = building_row_data[building_i].id
		} else {
			alert("紐付ける物件を選択してください。");
			return false;
		}
		
		document.create_trust_form.submit();

		
		return false;
	}
	
</script>

<% if flash[:notice] %>
	<div class="alert alert-warning alert-dismissible" role="alert" style="margin-bottom:0px;" id="alert-block">
	  <button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
	  <%= flash[:notice] %>
	</div>
<% end %>


<h3 style="padding-left:20px;">アタックリスト メンテナンス</h3>
<div id="owner_div" style="float:left;width:50%;height:40%;padding:0px 10px 10px 10px;margin-top:0px;">
	<table id="owner_table"></table>
	<div id = "owner_pager"></div>
</div>

<div id="building_div" style="float:left;;width:50%;height:40%;padding:0px 10px 10px 10px;">
	<table id="building_table"></table>
	<div id = "building_pager"></div>
</div>

<div style="clear:both;text-align:center;padding-top:20px;">
	<%= form_tag( {:action=>'attack_list_add'}, {:name=>'create_trust_form'}) do %>
		<%= hidden_field_tag :sid, @biru_trust_user.id %>
		<%= hidden_field_tag :owner_id, '' %>
		<%= hidden_field_tag :building_id, '' %>
		
		<%= submit_tag '▼ 貸主と物件の紐付けを作成 ▼', {:class=>'btn', :onClick=>'javascript:create_trust();return false;'} %>
	<% end %>
</div>

<div id="trust_div" style="width:100%;height:40%;padding:20px 10px 10px 10px;">
	<table id="trust_table"></table>
	<div id = "trust_pager"></div>
</div>

<div style="padding-left:10px;padding-top:10px;">
	<%= button_tag '貸主新規登録', {:class=>'btn', :onClick=>'javascript:create_trust();return false;'} %>
	<%= button_tag '建物新規登録', {:class=>'btn', :onClick=>'javascript:create_trust();return false;'} %>
	<%= button_tag '委託契約との紐付けを解除', {:class=>'btn', :onClick=>'javascript:create_trust();return false;'} %>
</div>


<!-- モーダルダイアログ -->
<div class="modal fade" id="modal-tack" tabindex="-1" role="dialog" aria-labelledby="modal-tack-label" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
	<%#= simple_form_for :trust, :url=>{:controller => :managements, :action => :popup_owner_trust_update }, :html=>{class: 'form-horizontal'} do |f| %>

      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 class="modal-title" id="myModalLabel">貸主新規作成</h4>
      </div>

	<%= form_tag({:action=>'tack_out'}, {:method=>'post', :name=>'tack_frm', :onSubmit=>"return tack_out_go()" }) do %>
	   <%= hidden_field_tag 'dm_owner_list', ''  %>
		<div class="modal-body">
			<div style="padding-bottom:20px;">
		       <%= radio_button_tag :dm_history, 1, true,  :onclick=>"dm_msg_regist_on(true);" %>&nbsp;DM履歴を残す
		       &nbsp;&nbsp;&nbsp;
		       <%= radio_button_tag :dm_history, 0, false, :onclick=>"dm_msg_regist_on(false);" %>&nbsp;DM履歴を残さない
		   </div>
			<div>
		       <label class="string optional control-label" for="tack_out_date">発行日</label>
			   <%= text_field_tag 'dm_out_date', Date.today.strftime("%Y-%m-%d"), :type=>'date' , :class=>'form-control', :style=>'width:180px;' %>


		       <label class="string optional control-label" for="dm_discription" style="margin-top:20px;">ＤＭ履歴の内容（送付するＤＭの概要など）</label>
			   <%= text_field_tag 'dm_out_msg', '', :class=>'form-control', :style=>'width:300px;'  %>
			   
		       <label class="string optional control-label" for="dm_discription" style="margin-top:20px;">宛名ラベル用紙種類</label>
			   <%= select_tag 'dm_tack_kind', options_for_select([["A-ONE 21面用", "pdf_layout_a_one_21.tlf"], ["PLUS ME-505T", "pdf_layout_plus_me505t.tlf"]]), :class=>'form-control', :style=>'width:150px;' %>
			   
			</div>
		</div>
		<div class="modal-footer">
		<%= submit_tag 'タックシールを出力' ,:class=>"btn btn-default", :style=>"margin:0" %>
		</div>
	<% end %>

    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
