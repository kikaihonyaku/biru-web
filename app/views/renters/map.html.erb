<% content_for :header do %>
<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false&v=3&language=ja&libraries=visualization"></script>

<script type="text/javascript">


  //-------------------
  // グローバル変数定義
  //-------------------
  var convert_shop = [];
  
  function initialize(){
    
	// ストリートビューの分割を縦に
	street_vew_vertical = true;
	
    // 初期化処理
    // init_process();

    // 初期表示は非表示
    init_display();
	
    // 地図・ストリートビューを作成します。
   init_map(<%= @biru_user.id %>, false);


    // 初期表示位置を調整
    var bounds = new google.maps.LatLngBounds();


    build_arr = {}; // グローバル
    kyori_text = ""
    var pos;
		
	gon.buildings.forEach(function(building){
        pos = new google.maps.LatLng(building.latitude, building.longitude);
        bounds.extend(pos);

        // infoWndに表示するHTMLを作成する。
        var inner_text;

		inner_text = "";
		
		room_cnt = 0;
		suumo_all = 0;
		suumo_all_summary = 0;
		
		var rooms = gon.rooms[building.id]
		rooms.forEach(function(room){
			sum = room.madori + room.gaikan + room.naikan + room.gaikan_etc + room.syuuhen
			//sum = room.all_sum
			
			res = get_suumo_remaining(room.madori, room.gaikan, room.naikan, room.gaikan_etc, room.syuuhen)
			suumo_all = 20 - res.remaining_suumo
			
			inner_text = inner_text + '<tr><td><a href="javascript:win_picture(' + room.id + ');">' + room.room_no + '</a></td><td><a href="http://www.rentersnet.jp/bukken/edit?roomAdRoomCd=' + room.room_code + '" target="_blank">' + room.room_code + '</a></td><td><a href="http://www.roomspot.net/area/room.php?room=' + room.room_code + '" target="_blank">' + sum + '枚</a></td><td>' + '<a href="http://suumo.jp/jj/chintai/ichiran/FR301FC011/?ar=030&bs=040&kskbn=01&fw=' + building.name + '" target="_blank">' + suumo_all + '枚</a></td></tr>'
				  

			suumo_all_summary = suumo_all_summary + suumo_all
			room_cnt = room_cnt + 1;
				  
		});
		
		
		if( room_cnt > 0 ){
			suumo_pic = suumo_all_summary / room_cnt;
		}
		else{
			suumo_pic = 0;
		}
		
		if(suumo_pic == 20){
			icon_url = "marker_blue.png"
		} else if(suumo_pic >= 10){
			icon_url = "marker_yellow.png"
			
		} else{
			icon_url = "marker_red.png"
		}

        build_arr[building.id] = createMarker({
          position : pos
          ,map : mapCanvas
          ,icon : '/assets/' + icon_url
          ,shadow : 'assets/msmarker_shadow.png'
          ,info_msg : building.name
         // ,html : vhtml
          ,html : building.name + ' <table class="sample_01" style="margin-top:5px;"><tr><th>号室</th><th>レンターズ</th><th>RSpot</th><th>SUUMO</th></tr>' + inner_text + '</table>' + '<div style="padding-top:0px;margin-top:5px;padding-left:10px;float:left;">' + '  <label><input type="checkbox" onclick="this.blur();this.focus();" onchange="view_disp( this.checked, ' + building.latitude + ',' + building.longitude  + '); return false;" />&nbsp;ストリートビュー</label>' +
		    '</div>'

        });

	});

    // ここで格納していたPosition情報を展開
    mapCanvas.fitBounds(bounds);

  } // end initialize

  google.maps.event.addDomListener(window, "load", initialize);


</script>

  <style type="text/css">
    html, body{
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
    }

    #map_canvas{
      position: fixed;
      width:100%;
      height:100%;
      top:0px;
      left:0;
    }

    #top-menu{
      padding:0;
      margin:0;
    }
	
	a{
	  text-decoration:underline;	
	}
	
	.sample_01{
	width: 100%;
	border-collapse: collapse;
	}
	.sample_01 th{
	padding: 3px;
	text-align: left;
	vertical-align: top;
	color: #333;
	background-color: #eee;
	border: 1px solid #b9b9b9;
	text-align: center;
	}
	.sample_01 td{
	padding: 3px;
	background-color: #fff;
	border: 1px solid #b9b9b9;
	text-align:center;
	}	
	
  </style>

<% end %>

<script type="text/javascript">

	$(function () {
		$(".accordion .toggle").click(function () {
			$(this).next("ul").slideToggle(200);
			$(this).next("div").slideToggle(200);
	
			$(this).toggleClass("open");
		});
	});

	// レンターズデータを表示します。
	init_renters_jqgrid();
	
	// 絞り込みテーブルを作成します。
	init_search_jqgrid();
	
	function init_renters_jqgrid(){
		// 列名の定義
		var grid_name = ["renters_room_id", "building_id", "営業所", "建物名", "部屋", "空室状況", "住所", "room_code", "SUMO合計残数", "間取り：残", "外観：残", "内観：残", "外観その他：残", "周辺：残"];
		
		// 列属性の定義
		var grid_model = [
		  {name:"renters_room_id", index:"renters_room_id", align:"right", classes:"no_class", hidden:true}
		 ,{name:"building_id", index:"building_id", align:"right", classes:"no_class", hidden:true}
		 ,{name:"store_name", index:"store_name", width:80, align:"center", classes:"no_class"}
		 ,{name:"real_building_name", index:"real_building_name", width:80, align:"center", classes:"no_class"}
		 ,{name:"real_room_name", index:"real_room_name", width:80, align:"center", classes:"no_class"}
		 ,{name:"vacant_div", index:"vacant_div", width:80, align:"center", classes:"no_class"}
		 ,{name:"address", index:"address", width:80, align:"center", classes:"no_class"}
		 ,{name:"room_code", index:"room_code", width:80, align:"center", classes:"no_class"}
		 ,{name:"suumo_sum", index:"suumo_sum", width:80, align:"center", classes:"no_class"}
		 ,{name:"madori", index:"madori", width:80, align:"center", classes:"no_class"}
		 ,{name:"gaikan", index:"gaikan", width:80, align:"center", classes:"no_class"}
		 ,{name:"naikan", index:"naikan", width:80, align:"center", classes:"no_class"}
		 ,{name:"gaikan_etc", index:"gaikan_etc", width:80, align:"center", classes:"no_class"}
		 ,{name:"syuuhen", index:"syuuhen", width:80, align:"center", classes:"no_class"}
		 
		];
		
		// データの作成
		var grid_data = [];
		gon.grid_renters_data.forEach(function(renters_data){
			var rec = {};
			rec['renters_room_id'] = renters_data.renters_room_id
			rec['building_id'] = renters_data.building_id
			rec['store_name'] = renters_data.store_name
			rec['real_building_name'] = renters_data.real_building_name
			rec['real_room_name'] = renters_data.real_room_no
			rec['address'] = renters_data.address
			rec['room_code'] = renters_data.room_code
			rec['vacant_div'] = renters_data.vacant_div
			
			tmp = get_suumo_remaining(renters_data.madori, renters_data.gaikan, renters_data.naikan, renters_data.gaikan_etc, renters_data.syuuhen)
			
			
			rec['suumo_sum'] = tmp.remaining_suumo
			rec['madori'] = tmp.remaining_madori
			rec['gaikan'] = tmp.remaining_gaikan
			rec['naikan'] = tmp.remaining_naikan
			rec['gaikan_etc'] = tmp.remaining_gaikan_etc
			rec['syuuhen'] = tmp.remaining_syuuhen
		
			grid_data.push(rec);
			
		});
		
		// その他の設定
		jqgrid_opt = {
			 table_name:'building_table'
			,fotter_name:'building_pager'
			,div_name:'div_dummy_02'
			,caption:'募集中物件を表示しています'
			,event_type:31
			,shrinkFit:true
			,multiselect:false
		};
			
		
		$(function(){
			jqgrid_create(grid_name, grid_model, grid_data, jqgrid_opt);
			
			// 反映ボタン押下
			jQuery("#building_table").navGrid('#building_pager',{
			        edit:false,add:false,del:false,search:false
			      }).navButtonAdd('#building_pager',{
			        caption:"地図に反映", position:"last", onClickButton: function(){
						alert('これはまだ未実装です');
					 }
			      });			
		});
	}
	
	
	// 絞り込み条件grid
	function init_search_jqgrid(){
		
		var col_names = ["部署の絞り込み", "リンク"];
	
		// 列属性の定義
		var col_model = [
		  {name:"store_name", index:"store_name", width:400, align:"left",classes:"no_class"}
 		 ,{name:"url", index:"url", align:"center", classes:"no_class", hidden:true}
		];
		
		// データの作成
		var grid_data = [];

	    grid_data.push({ url:  'map', store_name: '全体' }) 
	    grid_data.push({ url:  'map?stcd=335,336,339,334,340,337,338,667', store_name: '東武支店' }) 
	    grid_data.push({ url:  'map?stcd=2763,341,342,344,348,346,349,343,345', store_name: 'さいたま支店' }) 
	    grid_data.push({ url:  'map?stcd=352,347,351,350', store_name: '千葉支店' }) 
	    grid_data.push({ url:  'map?stcd=335',  store_name: '草加' }) 
	    grid_data.push({ url:  'map?stcd=336',  store_name: '草加新田' }) 
	    grid_data.push({ url:  'map?stcd=339',  store_name: '北千住' }) 
	    grid_data.push({ url:  'map?stcd=334',  store_name: '南越谷' }) 
	    grid_data.push({ url:  'map?stcd=340',  store_name: '越谷' }) 
	    grid_data.push({ url:  'map?stcd=337',  store_name: '北越谷' }) 
	    grid_data.push({ url:  'map?stcd=338',  store_name: '春日部' }) 
	    grid_data.push({ url:  'map?stcd=667',  store_name: 'せんげん台' }) 
	    grid_data.push({ url:  'map?stcd=2763',store_name: '戸田公園' }) 
	    grid_data.push({ url:  'map?stcd=341', store_name: '戸田' }) 
	    grid_data.push({ url:  'map?stcd=342', store_name: '武蔵浦和' }) 
	    grid_data.push({ url:  'map?stcd=344', store_name: '与野' }) 
	    grid_data.push({ url:  'map?stcd=348', store_name: '浦和' }) 
	    grid_data.push({ url:  'map?stcd=346', store_name: '川口' }) 
	    grid_data.push({ url:  'map?stcd=349', store_name: '東浦和' }) 
	    grid_data.push({ url:  'map?stcd=343', store_name: '東川口' }) 
	    grid_data.push({ url:  'map?stcd=345', store_name: '戸塚安行' }) 
	    grid_data.push({ url:  'map?stcd=352',  store_name: '松戸' }) 
	    grid_data.push({ url:  'map?stcd=347',  store_name: '北松戸' }) 
	    grid_data.push({ url:  'map?stcd=351',  store_name: '南流山' }) 
	    grid_data.push({ url:  'map?stcd=350',  store_name: '柏' }) 

		
		$(function(){

			var table_div = $('#search_table');
			var div_box = $('#search_div');

			table_div.jqGrid({
			  	data : grid_data,  //表示したいデータ
			  	datatype : "local",            //データの種別 他にjsonやxmlも選べます。しかし、私はlocalが推奨です。
			  	colNames : col_names,           //列の表示名
			  	colModel : col_model,   //列ごとの設定
			  	rowNum : 100,                   //一ページに表示する行数
				loadComplete : function () {  // 幅の%調整。読み込みが完了したあと指定のdivの幅と高さを%でとってきて設定
					table_div.jqGrid('setGridWidth', div_box.width(), true);
				    table_div.jqGrid('setGridHeight', div_box.height(), true);
				},
				
			    onSelectRow: function(id) {
				    data = table_div.getRowData(id);
					
					location.href = location.protocol + '//' + location.host + '/renters/' + data.url
				}
			});
			
		});
		
	}
	
	// suumoのそれぞれの残数をハッシュで返します
	function get_suumo_remaining(madori, gaikan, naikan, gaikan_etc, syuuhen){
		
		res = {};
		res.remaining_madori = 1 - madori
		if(res.remaining_madori < 0){
			res.remaining_madori = 0;
		}
		
		res.remaining_gaikan = 2 - gaikan
		if(res.remaining_gaikan < 0){
			res.remaining_gaikan = 0;
		}
		
		res.remaining_naikan = 9 - naikan
		if(res.remaining_naikan < 0){
			res.remaining_naikan = 0;
		}
		
		res.remaining_gaikan_etc = 2 - gaikan_etc
		if(res.remaining_gaikan_etc < 0){
			res.remaining_gaikan_etc = 0;
		}
		
		res.remaining_syuuhen = 6 - syuuhen
		if(res.remaining_syuuhen < 0){
			res.remaining_syuuhen = 0;
		}
		
		res.remaining_suumo = (res.remaining_madori + res.remaining_gaikan + res.remaining_naikan + res.remaining_gaikan_etc + res.remaining_syuuhen)  // SUMO算数の合計
		
		return res;
	}
	
	

</script>


  <!-- ここは span9で呼び出されているので合計も9に合わせる -->


	<a id="simple-menu" href="#sidr"></a>
	<div style="height:50%;padding:10px 20px 0px 20px;">
		
		<div id="div_dummy" style="float:left;width:20%;height:80%;padding:0;margin:0;padding-right:10px;">
			
			<div class="accordion ui-jqgrid  ui-widget-content ui-corner-all" style="width:100%;margin-bottom:10px;" >
			    <ul>
			        <li>
			            <span class="toggle  ui-jqgrid-view ui-jqgrid-titlebar ui-widget-header ui-corner-top ">SUUMO写真枚数</span>
						<div style="display:block;padding:5px;margin-left:10px;padding-top:10px;padding-bottom:10px;">
							
							<table style="margin-left:5px;">
							   <tbody>
							     <tr>
							       <td style="text-align:left;height:30px;width:25px;"><img alt="Marker_blue" src="/assets/marker_blue.png" /></td>
							       <td style="text-align:left;">ハイライトセット</td>
							     </tr>
							     <tr>
							       <td style="text-align:left;height:30px;width:25px;"><img alt="Marker_yellow" src="/assets/marker_yellow.png" /></td>
							       <td style="text-align:left;">10枚以上掲載</td>
							     </tr>
							     <tr>
							       <td style="text-align:left;height:30px;width:25px;"><img alt="Marker_red" src="/assets/marker_red.png" /></td>
							       <td style="text-align:left;">10枚未満</td>
							     </tr>
								 
							     <tr>
							       <td colspan="2" style="text-align:left;height:30px;padding-top:10px;">※１つの建物に複数の部屋がある場合は、<br/>&nbsp;&nbsp;その建物の平均掲載枚数を使用します。</td>
							     </tr>
							   </tbody>
							 </table>
						</div>
			        </li>
			    </ul>
			</div>
			
			
			
			<div class="accordion ui-jqgrid  ui-widget-content ui-corner-all" style="width:100%;margin-bottom:10px;" >
			    <ul>
			        <li>
			            <span class="toggle ui-jqgrid-view ui-jqgrid-titlebar ui-widget-header ui-corner-top">基本メニュー</span>
						
					</li>
			        </li>
			        <li><%= link_to "一覧へ戻る", renters_path %></li>
			    </ul>
			</div>
			
			<div id="search_div" style="width:100%;height:60%;margin-bottom:50px;">
				<table id="search_table" ></table>
				<div id="search_pager"></div>
			</div>
			
			
		</div>
		<div id="panowide" style="width: 100%; height: 0px;float:right;"></div>
		<div id="map_canvas" style="width: 80%;float:right;"></div>
		
	</div>
	<div id="div_dummy_02" style="clear:both;width:100%;height:40%;padding:10px 20px 10px 20px;margin-bottom:50px;">
		<table id="building_table"></table>
		<div id = "building_pager"></div>
	</div>
	

	<!-- For index -->

	  <style type="text/css">
		
		a{
		  text-decoration:underline;	
		}
		
	  </style>
	  



